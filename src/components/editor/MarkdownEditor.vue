<template>
  <div class="markdown-editor h-full flex flex-col">
    <!-- ÁºñËæëÂô®Â∑•ÂÖ∑Ê†è -->
    <div v-if="currentShowToolbar" class="editor-toolbar border-b border-gray-200 dark:border-dark-600 p-2">
      <div class="flex items-center justify-between">
        <div class="flex items-center space-x-2">
        <!-- Ê†ºÂºèÂåñÊåâÈíÆ -->
        <button
          @click="handleBold"
          class="toolbar-btn"
          title="Á≤ó‰Ωì (Ctrl+B)"
        >
          <svg class="w-4 h-4" fill="currentColor" viewBox="0 0 20 20">
            <path d="M5 3v14h5.5c1.4 0 2.5-.6 3.2-1.3.7-.8 1.3-1.8 1.3-3.2s-.6-2.4-1.3-3.2c.4-.4.7-.9.9-1.5.2-.6.3-1.2.3-1.8 0-1.4-.6-2.5-1.3-3.2C12.9 3.6 11.8 3 10.4 3H5zm3 5h2.5c.6 0 1.1.2 1.4.6.3.4.6.9.6 1.4s-.3 1-.6 1.4c-.3.4-.8.6-1.4.6H8V8zm0 7h3c.6 0 1.1-.2 1.4-.6.3-.4.6-.9.6-1.4s-.3-1-.6-1.4c-.3-.4-.8-.6-1.4-.6H8v4z"/>
          </svg>
        </button>
        
        <button
          @click="handleItalic"
          class="toolbar-btn"
          title="Êñú‰Ωì (Ctrl+I)"
        >
          <svg class="w-4 h-4" fill="currentColor" viewBox="0 0 20 20">
            <path d="M8 3h8v2h-2.5l-2 12H14v2H6v-2h2.5l2-12H8V3z"/>
          </svg>
        </button>
        
        <button
          @click="handleCode"
          class="toolbar-btn"
          title="‰ª£Á†Å"
        >
          <svg class="w-4 h-4" fill="currentColor" viewBox="0 0 20 20">
            <path fill-rule="evenodd" d="M12.316 3.051a1 1 0 01.633 1.265l-4 12a1 1 0 11-1.898-.632l4-12a1 1 0 011.265-.633zM5.707 6.293a1 1 0 010 1.414L3.414 10l2.293 2.293a1 1 0 11-1.414 1.414l-3-3a1 1 0 010-1.414l3-3a1 1 0 011.414 0zm8.586 0a1 1 0 011.414 0l3 3a1 1 0 010 1.414l-3 3a1 1 0 11-1.414-1.414L16.586 10l-2.293-2.293a1 1 0 010-1.414z" clip-rule="evenodd"/>
          </svg>
        </button>
        
        <div class="border-l border-gray-300 dark:border-dark-600 h-6 mx-2"></div>
        
        <button
          @click="handleHeading(1)"
          class="toolbar-btn"
          title="Ê†áÈ¢ò 1"
        >
          H1
        </button>
        
        <button
          @click="handleHeading(2)"
          class="toolbar-btn"
          title="Ê†áÈ¢ò 2"
        >
          H2
        </button>
        
        <button
          @click="handleHeading(3)"
          class="toolbar-btn"
          title="Ê†áÈ¢ò 3"
        >
          H3
        </button>
        
        <div class="border-l border-gray-300 dark:border-dark-600 h-6 mx-2"></div>
        
        <button
          @click="handleBulletList"
          class="toolbar-btn"
          title="Êó†Â∫èÂàóË°®"
        >
          <svg class="w-4 h-4" fill="currentColor" viewBox="0 0 20 20">
            <path fill-rule="evenodd" d="M3 4a1 1 0 011-1h12a1 1 0 110 2H4a1 1 0 01-1-1zm0 4a1 1 0 011-1h12a1 1 0 110 2H4a1 1 0 01-1-1zm0 4a1 1 0 011-1h12a1 1 0 110 2H4a1 1 0 01-1-1z" clip-rule="evenodd"/>
          </svg>
        </button>
        
        <button
          @click="handleOrderedList"
          class="toolbar-btn"
          title="ÊúâÂ∫èÂàóË°®"
        >
          <svg class="w-4 h-4" fill="currentColor" viewBox="0 0 20 20">
            <path fill-rule="evenodd" d="M3 4a1 1 0 011-1h12a1 1 0 110 2H4a1 1 0 01-1-1zm0 4a1 1 0 011-1h12a1 1 0 110 2H4a1 1 0 01-1-1zm0 4a1 1 0 011-1h12a1 1 0 110 2H4a1 1 0 01-1-1z" clip-rule="evenodd"/>
          </svg>
        </button>
        
        <div class="border-l border-gray-300 dark:border-dark-600 h-6 mx-2"></div>
        
        <!-- Ê®°ÂºèÊåáÁ§∫Âô® -->
        <div class="flex items-center text-xs text-gray-500 dark:text-gray-400 mr-3">
          <span class="mr-1">Ê®°Âºè:</span>
          <span class="font-medium">
            {{ currentViewMode === 'edit' ? (isWysiwygMode ? 'ÊâÄËßÅÂç≥ÊâÄÂæó' : 'Ê∫êÁ†Å') : currentViewMode === 'read' ? 'ÈòÖËØª' : 'Ê∫êÁ†Å' }}
          </span>
          <span v-if="currentViewMode === 'edit' && currentLayoutMode !== 'single'" class="ml-1 text-gray-400">
            | {{ currentLayoutMode === 'horizontal' ? 'Ê∞¥Âπ≥ÂàÜÂ±è' : currentLayoutMode === 'vertical' ? 'ÂûÇÁõ¥ÂàÜÂ±è' : '' }}
          </span>
          
          <!-- ÊÄßËÉΩË≠¶Âëä -->
          <span v-if="!isWysiwygMode && (isContentLarge || hasLargeImages)" class="ml-2 px-2 py-1 bg-yellow-100 dark:bg-yellow-900/20 text-yellow-700 dark:text-yellow-400 rounded text-xs" title="ÊñáÊ°£ÂåÖÂê´Â§ßÈáèÂÜÖÂÆπÊàñÂõæÁâáÔºåÊ∫êÁ†ÅÊ®°ÂºèÂèØËÉΩÂΩ±ÂìçÊÄßËÉΩ">
            ‚ö†Ô∏è Â§ßÊñáÊ°£
          </span>
          
          <!-- ÂõæÁâáÂ≠òÂÇ®‰ø°ÊÅØ -->
          <span class="ml-2 px-2 py-1 bg-green-100 dark:bg-green-900/20 text-green-700 dark:text-green-400 rounded text-xs">
            üìÅ ObsidianÂºèÂ≠òÂÇ®
          </span>
        </div>
        
        <!-- WYSIWYG Ê®°ÂºèÂàáÊç¢ÊåâÈíÆ -->
        <button
          @click="toggleWysiwygMode"
          class="toolbar-btn"
          :class="{ 'bg-primary-100 dark:bg-primary-900/20 text-primary-600 dark:text-primary-400': isWysiwygMode }"
          title="ÂàáÊç¢ÁºñËæëÊ®°Âºè"
        >
          <svg v-if="!isWysiwygMode" class="w-4 h-4" fill="currentColor" viewBox="0 0 20 20">
            <path fill-rule="evenodd" d="M3 4a1 1 0 011-1h12a1 1 0 110 2H4a1 1 0 01-1-1zm0 4a1 1 0 011-1h12a1 1 0 110 2H4a1 1 0 01-1-1zm0 4a1 1 0 011-1h12a1 1 0 110 2H4a1 1 0 01-1-1zm0 4a1 1 0 011-1h6a1 1 0 110 2H4a1 1 0 01-1-1z" clip-rule="evenodd"/>
          </svg>
          <svg v-else class="w-4 h-4" fill="currentColor" viewBox="0 0 20 20">
            <path fill-rule="evenodd" d="M12.316 3.051a1 1 0 01.633 1.265l-4 12a1 1 0 11-1.898-.632l4-12a1 1 0 011.265-.633zM5.707 6.293a1 1 0 010 1.414L3.414 10l2.293 2.293a1 1 0 11-1.414 1.414l-3-3a1 1 0 010-1.414l3-3a1 1 0 011.414 0zm8.586 0a1 1 0 011.414 0l3 3a1 1 0 010 1.414l-3 3a1 1 0 11-1.414-1.414L16.586 10l-2.293-2.293a1 1 0 010-1.414z" clip-rule="evenodd"/>
          </svg>
        </button>

        <!-- È¢ÑËßàÂàáÊç¢ÊåâÈíÆ (‰ªÖÂú®ÁºñËæëÊ®°ÂºèÂçïÂ±èÊó∂ÊòæÁ§∫) -->
        <button
          v-if="currentViewMode === 'edit' && currentLayoutMode === 'single' && !isWysiwygMode"
          @click="togglePreview"
          class="toolbar-btn"
          :class="{ 'bg-primary-100 dark:bg-primary-900/20 text-primary-600 dark:text-primary-400': showPreview }"
          :title="showPreview ? 'ÊòæÁ§∫ÁºñËæëÂô®' : 'ÊòæÁ§∫È¢ÑËßà'"
        >
          <svg v-if="!showPreview" class="w-4 h-4" fill="currentColor" viewBox="0 0 20 20">
            <path d="M10 12a2 2 0 100-4 2 2 0 000 4z"/>
            <path fill-rule="evenodd" d="M.458 10C1.732 5.943 5.522 3 10 3s8.268 2.943 9.542 7c-1.274 4.057-5.064 7-9.542 7S1.732 14.057.458 10zM14 10a4 4 0 11-8 0 4 4 0 018 0z" clip-rule="evenodd"/>
          </svg>
          <svg v-else class="w-4 h-4" fill="currentColor" viewBox="0 0 20 20">
            <path fill-rule="evenodd" d="M12.316 3.051a1 1 0 01.633 1.265l-4 12a1 1 0 11-1.898-.632l4-12a1 1 0 011.265-.633zM5.707 6.293a1 1 0 010 1.414L3.414 10l2.293 2.293a1 1 0 11-1.414 1.414l-3-3a1 1 0 010-1.414l3-3a1 1 0 011.414 0zm8.586 0a1 1 0 011.414 0l3 3a1 1 0 010 1.414l-3 3a1 1 0 11-1.414-1.414L16.586 10l-2.293-2.293a1 1 0 010-1.414z" clip-rule="evenodd"/>
          </svg>
        </button>
        </div>
      </div>
    </div>
    
    <!-- ÁºñËæëÂô®ÂÜÖÂÆπÂå∫Âüü -->
    <div class="flex-1 flex" :class="getLayoutClass()">
      <!-- ÁºñËæëÂô®Âå∫Âüü -->
      <div 
        v-if="currentViewMode !== 'read'"
        :class="getEditorClass()" 
        class="relative"
      >
        <!-- Milkdown WYSIWYG ÁºñËæëÂô® -->
        <div
          v-if="isWysiwygMode"
          ref="milkdownRef"
          class="milkdown-editor h-full overflow-y-auto focus:outline-none p-4"
        ></div>
        
        <!-- ‰º†ÁªüÊñáÊú¨ÁºñËæëÂô® -->
        <textarea
          v-else
          ref="textareaRef"
          v-model="content"
          class="editor-textarea"
          :placeholder="placeholder"
          @input="onInput"
          @keydown="onKeydown"
          @scroll="onScroll"
          @paste="onTextareaPaste"
        ></textarea>
        
        <!-- Ë°åÂè∑ -->
        <div v-if="showLineNumbers && !isWysiwygMode" class="line-numbers">
          <div
            v-for="lineNumber in lineCount"
            :key="lineNumber"
            class="line-number"
          >
            {{ lineNumber }}
          </div>
        </div>
      </div>
      
      <!-- È¢ÑËßàÂå∫Âüü -->
      <div
        v-if="shouldShowPreview"
        :class="getPreviewClass()"
        class="overflow-y-auto"
        :style="{ scrollTop: previewScrollTop }"
        ref="previewRef"
      >
        <div class="prose prose-gray dark:prose-invert max-w-none p-4" v-html="renderedContent"></div>
      </div>
    </div>
    
    <!-- Êü•ÊâæÊõøÊç¢ÂØπËØùÊ°Ü -->
    <div
      v-if="showFindReplace"
      class="find-replace-dialog absolute top-16 right-4 bg-white dark:bg-dark-800 border border-gray-200 dark:border-dark-600 rounded-lg shadow-lg p-4 z-40 w-80"
    >
      <div class="flex items-center justify-between mb-3">
        <h3 class="text-sm font-medium text-gray-900 dark:text-gray-100">Êü•ÊâæÊõøÊç¢</h3>
        <button @click="showFindReplace = false" class="text-gray-400 hover:text-gray-600">
          <svg class="w-4 h-4" fill="currentColor" viewBox="0 0 20 20">
            <path fill-rule="evenodd" d="M4.293 4.293a1 1 0 011.414 0L10 8.586l4.293-4.293a1 1 0 111.414 1.414L11.414 10l4.293 4.293a1 1 0 01-1.414 1.414L10 11.414l-4.293 4.293a1 1 0 01-1.414-1.414L8.586 10 4.293 5.707a1 1 0 010-1.414z" clip-rule="evenodd"/>
          </svg>
        </button>
      </div>
      
      <div class="space-y-3">
        <input
          v-model="findText"
          type="text"
          placeholder="Êü•ÊâæÂÜÖÂÆπ"
          class="w-full px-3 py-2 border border-gray-300 dark:border-dark-600 rounded-md text-sm bg-white dark:bg-dark-700 text-gray-900 dark:text-gray-100"
          @keydown.enter="findNext"
        />
        <input
          v-model="replaceText"
          type="text"
          placeholder="ÊõøÊç¢‰∏∫"
          class="w-full px-3 py-2 border border-gray-300 dark:border-dark-600 rounded-md text-sm bg-white dark:bg-dark-700 text-gray-900 dark:text-gray-100"
          @keydown.enter="replaceNext"
        />
        
        <div class="flex items-center space-x-2">
          <button @click="findNext" class="px-3 py-1 bg-primary-600 text-white rounded text-sm hover:bg-primary-700">Êü•Êâæ‰∏ã‰∏Ä‰∏™</button>
          <button @click="replaceNext" class="px-3 py-1 bg-gray-600 text-white rounded text-sm hover:bg-gray-700">ÊõøÊç¢</button>
          <button @click="replaceAll" class="px-3 py-1 bg-gray-600 text-white rounded text-sm hover:bg-gray-700">ÂÖ®ÈÉ®ÊõøÊç¢</button>
        </div>
        
        <div class="flex items-center space-x-4 text-sm">
          <label class="flex items-center">
            <input v-model="caseSensitive" type="checkbox" class="mr-1" />
            Â§ßÂ∞èÂÜôÊïèÊÑü
          </label>
          <label class="flex items-center">
            <input v-model="wholeWord" type="checkbox" class="mr-1" />
            ÂÖ®ËØçÂåπÈÖç
          </label>
        </div>
      </div>
    </div>
  </div>
</template>

<script setup lang="ts">
import { ref, computed, watch, nextTick, onMounted, onUnmounted } from 'vue';
import MarkdownIt from 'markdown-it';
import { defaultValueCtx, Editor, editorViewOptionsCtx, rootCtx } from '@milkdown/core';
import { commonmark } from '@milkdown/preset-commonmark';
import { nord } from '@milkdown/theme-nord';
import { listener, listenerCtx } from '@milkdown/plugin-listener';
import { history } from '@milkdown/plugin-history';
import { cursor } from '@milkdown/plugin-cursor';
import { block } from '@milkdown/plugin-block';

interface Props {
  modelValue: string;
  placeholder?: string;
  showLineNumbers?: boolean;
  viewMode?: 'edit' | 'read' | 'source';
  layoutMode?: 'single' | 'horizontal' | 'vertical';
  showToolbar?: boolean;
}

interface Emits {
  (e: 'update:modelValue', value: string): void;
  (e: 'change', value: string): void;
  (e: 'save'): void;
}

const props = withDefaults(defineProps<Props>(), {
  placeholder: 'ÂºÄÂßãÂÜô‰Ωú...',
  showLineNumbers: false,
  viewMode: 'edit',
  layoutMode: 'single',
  showToolbar: true,
});

const emit = defineEmits<Emits>();

const md = new MarkdownIt({
  html: true,
  linkify: true,
  typographer: true,
});

// ÂìçÂ∫îÂºèÁä∂ÊÄÅ
const textareaRef = ref<HTMLTextAreaElement>();
const previewRef = ref<HTMLElement>();
const milkdownRef = ref<HTMLElement>();
const content = ref(props.modelValue);
const showPreview = ref(false);
const previewScrollTop = ref(0);

// Milkdown Áõ∏ÂÖ≥Áä∂ÊÄÅ
const isWysiwygMode = ref(true); // ÈªòËÆ§‰∏∫ÊâÄËßÅÂç≥ÊâÄÂæóÊ®°Âºè
let milkdownEditor: Editor | null = null;
let isUpdatingMilkdown = false;

// ÂõæÁâáÂ§ÑÁêÜÁõ∏ÂÖ≥Áä∂ÊÄÅÔºàÂ∑≤Êîπ‰∏∫ObsidianÂºèÂ≠òÂÇ®Ôºå‰∏çÂÜçÈúÄË¶ÅÁºìÂ≠òÔºâ

// Êü•ÊâæÊõøÊç¢Áõ∏ÂÖ≥Áä∂ÊÄÅ
const showFindReplace = ref(false);

// ËÆ°ÁÆóÂ±ûÊÄßÔºå‰ºòÂÖà‰ΩøÁî®Áà∂ÁªÑ‰ª∂‰º†ÂÖ•ÁöÑprops
const currentViewMode = computed(() => props.viewMode);
const currentLayoutMode = computed(() => props.layoutMode);
const currentShowToolbar = computed(() => props.showToolbar);

// Ê£ÄÊü•ÂÜÖÂÆπÊòØÂê¶ËøáÂ§ßÔºåÂèØËÉΩÂΩ±ÂìçÊÄßËÉΩ
const isContentLarge = computed(() => {
  return content.value.length > 50000; // Ë∂ÖËøá50KBÁöÑÂÜÖÂÆπËÆ§‰∏∫ÊòØÂ§ßÂÜÖÂÆπ
});

const hasLargeImages = computed(() => {
  return content.value.includes('![[') && content.value.length > 50000; // ÁÆÄÂçïÊ£ÄÊµãÊòØÂê¶ÊúâÂõæÁâá‰∏îÂÜÖÂÆπËæÉÂ§ß
});

// Êü•ÊâæÊõøÊç¢Áõ∏ÂÖ≥Áä∂ÊÄÅ
const findText = ref('');
const replaceText = ref('');
const caseSensitive = ref(false);
const wholeWord = ref(false);
const currentMatchIndex = ref(-1);
const totalMatches = ref(0);

// ËÆ°ÁÆóÂ±ûÊÄß
const renderedContent = computed(() => {
  const processedContent = processContentForDisplay(content.value);
  return md.render(processedContent);
});

const lineCount = computed(() => {
  return content.value.split('\n').length;
});

const shouldShowPreview = computed(() => {
  // ÈòÖËØªÊ®°ÂºèÔºöÂè™ÊòæÁ§∫È¢ÑËßà
  if (currentViewMode.value === 'read') return true;
  
  // Ê∫êÁ†ÅÊ®°ÂºèÔºö‰∏çÊòæÁ§∫È¢ÑËßà
  if (currentViewMode.value === 'source') return false;
  
  // ÁºñËæëÊ®°ÂºèÔºöÊ†πÊçÆÂ∏ÉÂ±ÄÊ®°ÂºèÂÜ≥ÂÆö
  if (currentViewMode.value === 'edit') {
    // ÂçïÂ±èÊ®°ÂºèÔºöÊâãÂä®ÂàáÊç¢È¢ÑËßà
    if (currentLayoutMode.value === 'single') return showPreview.value;
    // ÂàÜÂ±èÊ®°ÂºèÔºöÂßãÁªàÊòæÁ§∫È¢ÑËßà
    return true;
  }
  
  return false;
});

const getLayoutClass = () => {
  if (currentLayoutMode.value === 'vertical') return 'flex-col';
  return 'flex-row';
};

const getEditorClass = () => {
  // ÈòÖËØªÊ®°ÂºèÔºöÈöêËóèÁºñËæëÂô®
  if (currentViewMode.value === 'read') return 'hidden';
  
  // Ê∫êÁ†ÅÊ®°ÂºèÂíåÁºñËæëÊ®°Âºè
  if (currentLayoutMode.value === 'single') {
    // ÂçïÂ±èÊ®°ÂºèÔºöÂ¶ÇÊûúÊòæÁ§∫È¢ÑËßàÂàôÈöêËóèÁºñËæëÂô®ÔºåÂê¶ÂàôÂÖ®Â±è
    return shouldShowPreview.value ? 'hidden' : 'w-full';
  }
  
  // ÂàÜÂ±èÊ®°Âºè
  if (currentLayoutMode.value === 'horizontal') return 'w-1/2';
  if (currentLayoutMode.value === 'vertical') return 'h-1/2';
  
  return 'w-full';
};

const getPreviewClass = () => {
  // ÈòÖËØªÊ®°ÂºèÔºöÂÖ®Â±èÊòæÁ§∫
  if (currentViewMode.value === 'read') return 'w-full';
  
  // ÂçïÂ±èÊ®°ÂºèÔºöÂÖ®Â±èÊòæÁ§∫È¢ÑËßà
  if (currentLayoutMode.value === 'single') return 'w-full';
  
  // ÂàÜÂ±èÊ®°Âºè
  if (currentLayoutMode.value === 'horizontal') return 'w-1/2 border-l border-gray-200 dark:border-dark-600';
  if (currentLayoutMode.value === 'vertical') return 'h-1/2 border-t border-gray-200 dark:border-dark-600';
  
  return 'w-1/2 border-l border-gray-200 dark:border-dark-600';
};

// ÁõëÂê¨Â§ñÈÉ®ÂÄºÂèòÂåñ
watch(() => props.modelValue, (newValue) => {
  if (newValue !== content.value) {
    content.value = newValue;
  }
});

// ÁõëÂê¨ÂÜÖÂÆπÂèòÂåñ
watch(content, (newContent) => {
  emit('update:modelValue', newContent);
  emit('change', newContent);
});

// ÁõëÂê¨Áî®Êà∑ËæìÂÖ•Ôºå‰øùÂ≠òÂéÜÂè≤
let inputTimer: number | null = null;
function onInput() {
  // Âª∂Ëøü‰øùÂ≠òÂéÜÂè≤ÔºåÈÅøÂÖçÈ¢ëÁπÅÊìç‰Ωú
  if (inputTimer) {
    clearTimeout(inputTimer);
  }
  inputTimer = setTimeout(() => {
    saveToHistory();
  }, 1000);
}

// Âú®È¶ñÊ¨°Âä†ËΩΩÊó∂‰øùÂ≠òÂàùÂßãÁä∂ÊÄÅ
watch(() => props.modelValue, (newValue) => {
  if (newValue !== content.value) {
    content.value = newValue;
    if (undoStack.value.length === 0) {
      saveToHistory();
    }
  }
}, { immediate: true });


// ÊñπÊ≥ï - onInput Â∑≤Âú®‰∏äÈù¢ÂÆö‰πâ

function onKeydown(event: KeyboardEvent) {
  const textarea = textareaRef.value!;
  const { selectionStart, selectionEnd } = textarea;
  
  // TabÈîÆÁº©Ëøõ
  if (event.key === 'Tab') {
    event.preventDefault();
    const beforeCursor = content.value.substring(0, selectionStart);
    const afterCursor = content.value.substring(selectionEnd);
    
    if (event.shiftKey) {
      // Shift+Tab ÂáèÂ∞ëÁº©Ëøõ
      const lines = beforeCursor.split('\n');
      const currentLine = lines[lines.length - 1];
      if (currentLine.startsWith('  ')) {
        lines[lines.length - 1] = currentLine.substring(2);
        content.value = lines.join('\n') + afterCursor;
        nextTick(() => {
          textarea.setSelectionRange(selectionStart - 2, selectionStart - 2);
        });
      }
    } else {
      // Tab Â¢ûÂä†Áº©Ëøõ
      content.value = beforeCursor + '  ' + afterCursor;
      nextTick(() => {
        textarea.setSelectionRange(selectionStart + 2, selectionStart + 2);
      });
    }
  }
  
  // EnterÈîÆËá™Âä®Áº©Ëøõ
  if (event.key === 'Enter') {
    const beforeCursor = content.value.substring(0, selectionStart);
    const lines = beforeCursor.split('\n');
    const currentLine = lines[lines.length - 1];
    
    // Ê£ÄÊü•ÂΩìÂâçË°åÁöÑÁº©Ëøõ
    const indentMatch = currentLine.match(/^(\s*)/);
    const indent = indentMatch ? indentMatch[1] : '';
    
    // Ê£ÄÊü•ÊòØÂê¶ÊòØÂàóË°®È°π
    const listMatch = currentLine.match(/^(\s*)([-*+]|\d+\.)\s/);
    if (listMatch) {
      event.preventDefault();
      const listIndent = listMatch[1];
      const listMarker = listMatch[2];
      
      if (currentLine.trim() === listMarker) {
        // Á©∫ÂàóË°®È°πÔºåÂà†Èô§Ê†áËÆ∞
        const newContent = beforeCursor.substring(0, beforeCursor.lastIndexOf('\n') + 1) + 
                          content.value.substring(selectionEnd);
        content.value = newContent;
        nextTick(() => {
          const newPosition = beforeCursor.lastIndexOf('\n') + 1;
          textarea.setSelectionRange(newPosition, newPosition);
        });
      } else {
        // ÁªßÁª≠ÂàóË°®
        const newMarker = listMarker.match(/\d+/) ? 
          `${parseInt(listMarker) + 1}.` : listMarker;
        const insertion = `\n${listIndent}${newMarker} `;
        content.value = beforeCursor + insertion + content.value.substring(selectionEnd);
        nextTick(() => {
          textarea.setSelectionRange(selectionStart + insertion.length, selectionStart + insertion.length);
        });
      }
    } else if (indent) {
      // ‰øùÊåÅÁº©Ëøõ
      event.preventDefault();
      const insertion = `\n${indent}`;
      content.value = beforeCursor + insertion + content.value.substring(selectionEnd);
      nextTick(() => {
        textarea.setSelectionRange(selectionStart + insertion.length, selectionStart + insertion.length);
      });
    }
  }
}

function onScroll(event: Event) {
  const textarea = event.target as HTMLTextAreaElement;
  const scrollPercentage = textarea.scrollTop / (textarea.scrollHeight - textarea.clientHeight);
  
  // ÂêåÊ≠•È¢ÑËßàÂå∫ÂüüÊªöÂä®
  if (showPreview.value) {
    const previewElement = textarea.parentElement?.nextElementSibling as HTMLElement;
    if (previewElement) {
      previewScrollTop.value = scrollPercentage * (previewElement.scrollHeight - previewElement.clientHeight);
    }
  }
}

// Â§ÑÁêÜtextareaÁöÑÁ≤òË¥¥‰∫ã‰ª∂
async function onTextareaPaste(event: ClipboardEvent) {
  const handled = await handlePasteWithImages(event);
  if (!handled) {
    // Â¶ÇÊûúÊ≤°ÊúâÂ§ÑÁêÜÂõæÁâáÔºåËÆ©ÈªòËÆ§ÁöÑÁ≤òË¥¥Ë°å‰∏∫ÁªßÁª≠
    return;
  }
}

// Â§ÑÁêÜMilkdownÁöÑÁ≤òË¥¥‰∫ã‰ª∂
async function handleMilkdownPaste(event: ClipboardEvent) {
  const handled = await handlePasteWithImages(event);
  if (!handled) {
    // Â¶ÇÊûúÊ≤°ÊúâÂ§ÑÁêÜÂõæÁâáÔºåËÆ©ÈªòËÆ§ÁöÑÁ≤òË¥¥Ë°å‰∏∫ÁªßÁª≠
    return;
  }
}

// Â∑•ÂÖ∑Ê†èÂ§ÑÁêÜÂáΩÊï∞
function handleBold() {
  if (isWysiwygMode.value && milkdownEditor) {
    try {
      milkdownEditor.action((ctx) => {
        // Ëé∑ÂèñÂΩìÂâçËßÜÂõæÂπ∂ÊâßË°åÊ†ºÂºèÂåñÂëΩ‰ª§
        const view = ctx.get(editorViewOptionsCtx);
        // ‰ΩøÁî®ÊñáÊ°£ÊâßË°åÂëΩ‰ª§ÔºåËøôÊòØÊõ¥ÈÄöÁî®ÁöÑÊñπÊ≥ï
        document.execCommand('bold', false);
      });
    } catch (error) {
      console.warn('Bold command failed in Milkdown, fallback to text mode');
      insertFormat('**', '**');
    }
  } else {
    insertFormat('**', '**');
  }
}

function handleItalic() {
  if (isWysiwygMode.value && milkdownEditor) {
    try {
      milkdownEditor.action((ctx) => {
        document.execCommand('italic', false);
      });
    } catch (error) {
      console.warn('Italic command failed in Milkdown, fallback to text mode');
      insertFormat('*', '*');
    }
  } else {
    insertFormat('*', '*');
  }
}

function handleCode() {
  if (isWysiwygMode.value && milkdownEditor) {
    // ÂØπ‰∫éÂÜÖËÅî‰ª£Á†ÅÔºåÊàë‰ª¨‰ΩøÁî®ÁÆÄÂçïÁöÑÊñáÊú¨ÊèíÂÖ•
    insertFormat('`', '`');
  } else {
    insertFormat('`', '`');
  }
}

function handleHeading(level: number) {
  if (isWysiwygMode.value && milkdownEditor) {
    try {
      // ‰∏∫Ê†áÈ¢ò‰ΩøÁî®ÁÆÄÂåñÁöÑÊñπÊ≥ï
      const headingText = '#'.repeat(level) + ' ';
      insertFormat(headingText, '');
    } catch (error) {
      insertHeading(level);
    }
  } else {
    insertHeading(level);
  }
}

function handleBulletList() {
  if (isWysiwygMode.value && milkdownEditor) {
    insertFormat('- ', '');
  } else {
    insertList('-');
  }
}

function handleOrderedList() {
  if (isWysiwygMode.value && milkdownEditor) {
    insertFormat('1. ', '');
  } else {
    insertList('1.');
  }
}

function insertFormat(before: string, after: string) {
  if (isWysiwygMode.value && milkdownEditor) {
    // Âú®MilkdownÊ®°Âºè‰∏ãÔºåÁõ¥Êé•Êìç‰ΩúÂÜÖÂÆπ
    const selection = window.getSelection();
    if (selection && selection.rangeCount > 0) {
      const range = selection.getRangeAt(0);
      const selectedText = range.toString();
      const replacement = before + selectedText + after;
      
      range.deleteContents();
      const textNode = document.createTextNode(replacement);
      range.insertNode(textNode);
      
      // ËÆæÁΩÆÂÖâÊ†á‰ΩçÁΩÆ
      range.setStartAfter(textNode);
      range.setEndAfter(textNode);
      selection.removeAllRanges();
      selection.addRange(range);
    }
  } else if (textareaRef.value) {
    const textarea = textareaRef.value;
    const { selectionStart, selectionEnd } = textarea;
    const selectedText = content.value.substring(selectionStart, selectionEnd);
    
    const replacement = before + selectedText + after;
    content.value = content.value.substring(0, selectionStart) + replacement + content.value.substring(selectionEnd);
    
    nextTick(() => {
      if (selectedText) {
        textarea.setSelectionRange(selectionStart, selectionStart + replacement.length);
      } else {
        textarea.setSelectionRange(selectionStart + before.length, selectionStart + before.length);
      }
      textarea.focus();
    });
  }
}

function insertHeading(level: number) {
  const textarea = textareaRef.value!;
  const { selectionStart } = textarea;
  const beforeCursor = content.value.substring(0, selectionStart);
  const afterCursor = content.value.substring(selectionStart);
  
  const lines = beforeCursor.split('\n');
  const currentLineIndex = lines.length - 1;
  const currentLine = lines[currentLineIndex];
  
  const headingPrefix = '#'.repeat(level) + ' ';
  
  if (currentLine.trim() === '') {
    // Á©∫Ë°åÔºåÁõ¥Êé•ÊèíÂÖ•Ê†áÈ¢òÊ†áËÆ∞
    lines[currentLineIndex] = headingPrefix;
  } else {
    // ÈùûÁ©∫Ë°åÔºåËΩ¨Êç¢‰∏∫Ê†áÈ¢ò
    lines[currentLineIndex] = headingPrefix + currentLine.replace(/^#+\s*/, '');
  }
  
  content.value = lines.join('\n') + afterCursor;
  
  nextTick(() => {
    const newPosition = lines.join('\n').length;
    textarea.setSelectionRange(newPosition, newPosition);
    textarea.focus();
  });
}

function insertList(marker: string) {
  const textarea = textareaRef.value!;
  const { selectionStart } = textarea;
  const beforeCursor = content.value.substring(0, selectionStart);
  const afterCursor = content.value.substring(selectionStart);
  
  const lines = beforeCursor.split('\n');
  const currentLineIndex = lines.length - 1;
  const currentLine = lines[currentLineIndex];
  
  const listPrefix = marker === '1.' ? '1. ' : '- ';
  
  if (currentLine.trim() === '') {
    lines[currentLineIndex] = listPrefix;
  } else {
    lines[currentLineIndex] = listPrefix + currentLine;
  }
  
  content.value = lines.join('\n') + afterCursor;
  
  nextTick(() => {
    const newPosition = lines.join('\n').length;
    textarea.setSelectionRange(newPosition, newPosition);
    textarea.focus();
  });
}

function togglePreview() {
  showPreview.value = !showPreview.value;
}

// Milkdown ÁºñËæëÂô®ÂàùÂßãÂåñ
async function initMilkdownEditor() {
  if (!milkdownRef.value) return;

  try {
    milkdownEditor = await Editor.make()
      .config((ctx) => {
        ctx.set(rootCtx, milkdownRef.value);
        // ‰ΩøÁî®Â§ÑÁêÜËøáÁöÑÂÜÖÂÆπÂàùÂßãÂåñÁºñËæëÂô®ÔºåÁ°Æ‰øùÂõæÁâáËÉΩÊ≠£Á°ÆÊòæÁ§∫
        const initialContent = processContentForDisplay(content.value || '');
        ctx.set(defaultValueCtx, initialContent);
        ctx.set(editorViewOptionsCtx, { 
          editable: () => true,
          attributes: {
            class: 'milkdown-editor-content prose prose-gray dark:prose-invert max-w-none outline-none'
          },
          // ÈÖçÁΩÆÁºñËæëÂô®Ë°å‰∏∫ÔºåÂáèÂ∞ëËá™Âä®Ê†ºÂºèÂåñ
          transformPastedHTML: (html: string) => html,
          clipboardTextParser: (text: string) => text
        });
        
        // ÁõëÂê¨ÁºñËæëÂô®ÂÜÖÂÆπÂèòÂåñ
        ctx.get(listenerCtx).markdownUpdated((ctx, markdown) => {
          // Âè™ÊúâÂú®ÈùûÊõ¥Êñ∞Áä∂ÊÄÅ‰∏ãÊâçÂ§ÑÁêÜÁºñËæëÂô®ÁöÑÂèòÂåñ
          if (!isUpdatingMilkdown) {
            // Ê∏ÖÁêÜMilkdownÁîüÊàêÁöÑÈ¢ùÂ§ñÊç¢Ë°åÁ¨¶Ôºå‰øùÊåÅ‰∏éÊñáÊú¨Ê®°Âºè‰∏ÄËá¥
            let cleanedMarkdown = markdown
              .replace(/\n\n+/g, '\n\n') // Â∞ÜÂ§ö‰∏™ËøûÁª≠Êç¢Ë°åÁ¨¶ÁÆÄÂåñ‰∏∫ÊúÄÂ§ö‰∏§‰∏™
              .replace(/^\n+/, '') // ÁßªÈô§ÂºÄÂ§¥ÁöÑÊç¢Ë°åÁ¨¶
              .replace(/\n+$/, ''); // ÁßªÈô§ÁªìÂ∞æÁöÑÊç¢Ë°åÁ¨¶
            
            const convertedMarkdown = convertImageRefsFromMarkdown(cleanedMarkdown);
            if (convertedMarkdown !== content.value) {
              content.value = convertedMarkdown;
              emit('update:modelValue', convertedMarkdown);
              emit('change', convertedMarkdown);
            }
          }
        });
        
        // ÁõëÂê¨Á≤òË¥¥‰∫ã‰ª∂
        ctx.get(listenerCtx).beforeMount((ctx) => {
          const editorView = ctx.get(editorViewOptionsCtx);
          // ËøôÂ∞ÜÂú®ÁºñËæëÂô®ÊåÇËΩΩÂêéÊ∑ªÂä†Á≤òË¥¥Â§ÑÁêÜ
          nextTick(() => {
            if (milkdownRef.value) {
              milkdownRef.value.addEventListener('paste', handleMilkdownPaste);
            }
          });
        });
      })
      .config(nord)
      .use(commonmark)
      .use(listener)
      .use(history)
      .use(cursor)
      .use(block)
      .create();
      
      console.log('Milkdown editor initialized successfully');
      
      // Â¶ÇÊûúÊúâÂÜÖÂÆπÈúÄË¶ÅÊõ¥Êñ∞ÔºåÂú®ÂàùÂßãÂåñÂêéÁ´ãÂç≥Êõ¥Êñ∞
      if (content.value) {
        await nextTick();
        const processedContent = processContentForDisplay(content.value);
        await milkdownEditor.action((ctx) => {
          ctx.set(defaultValueCtx, processedContent);
        });
      }
  } catch (error) {
    console.error('Failed to initialize Milkdown editor:', error);
    // Â¶ÇÊûúMilkdownÂàùÂßãÂåñÂ§±Ë¥•ÔºåÂõûÈÄÄÂà∞ÊñáÊú¨Ê®°Âºè
    isWysiwygMode.value = false;
  }
}

// ÁºñËæëÂô®Ê®°ÂºèÂàáÊç¢
function toggleWysiwygMode() {
  isWysiwygMode.value = !isWysiwygMode.value;
  
  if (isWysiwygMode.value) {
    // ÂàáÊç¢Âà∞ Milkdown WYSIWYG Ê®°Âºè
    nextTick(() => {
      initMilkdownEditor();
    });
  } else {
    // ÂàáÊç¢ÂõûÊñáÊú¨Ê®°ÂºèÔºåÈîÄÊØÅMilkdownÁºñËæëÂô®
    if (milkdownEditor) {
      milkdownEditor.destroy();
      milkdownEditor = null;
    }
    nextTick(() => {
      if (textareaRef.value) {
        textareaRef.value.focus();
      }
    });
  }
}

// ÂõæÁâáÂ§ÑÁêÜÂáΩÊï∞ - ObsidianÂºèÂ≠òÂÇ®
async function handleImagePaste(file: File): Promise<string> {
  try {
    // ÁîüÊàêÊó∂Èó¥Êà≥ÂíåÈöèÊú∫Êï∞‰Ωú‰∏∫Êñá‰ª∂Âêç
    const timestamp = new Date().toISOString().replace(/[:.]/g, '-').slice(0, -5);
    const random = Math.random().toString(36).substring(2, 8);
    const extension = file.type.split('/')[1] || 'png';
    const fileName = `${timestamp}_${random}.${extension}`;
    
    // ËØªÂèñÊñá‰ª∂Âπ∂ËΩ¨Êç¢‰∏∫base64
    const reader = new FileReader();
    const base64Data = await new Promise<string>((resolve, reject) => {
      reader.onload = (e) => resolve(e.target?.result as string);
      reader.onerror = reject;
      reader.readAsDataURL(file);
    });
    
    // ‰øùÂ≠òÂõæÁâáÂà∞Êú¨Âú∞ÈôÑ‰ª∂ÁõÆÂΩï
    const savedPath = await window.electronAPI.fs.saveImage(base64Data, fileName);
    console.log('ÂõæÁâáÂ∑≤‰øùÂ≠òÂà∞:', savedPath);
    
    // ËøîÂõûObsidianÂºèÂºïÁî®Ê†ºÂºè
    return `![[${fileName}]]`;
  } catch (error) {
    console.error('‰øùÂ≠òÂõæÁâáÂ§±Ë¥•:', error);
    throw error;
  }
}

// Â§ÑÁêÜÂõæÁâáÁ≤òË¥¥‰∫ã‰ª∂
async function handlePasteWithImages(event: ClipboardEvent) {
  const clipboardData = event.clipboardData;
  if (!clipboardData) return false;
  
  const items = Array.from(clipboardData.items);
  const imageItems = items.filter(item => item.type.startsWith('image/'));
  
  if (imageItems.length === 0) return false;
  
  event.preventDefault();
  
  try {
    const imagePromises = imageItems.map(item => {
      const file = item.getAsFile();
      if (file) {
        return handleImagePaste(file);
      }
      return Promise.resolve('');
    });
    
    const imageRefs = await Promise.all(imagePromises);
    const imageText = imageRefs.filter(ref => ref).join('\n\n');
    
    // ÁÆÄÂåñÂ§ÑÁêÜÔºöÁõ¥Êé•Êõ¥Êñ∞contentÔºåËÆ©ÁºñËæëÂô®Ëá™Âä®Â§ÑÁêÜ
    if (isWysiwygMode.value) {
      // Ëé∑ÂèñÂΩìÂâçÂÖâÊ†á‰ΩçÁΩÆÔºàÈÄöËøámilkdownÁºñËæëÂô®Ôºâ
      const currentContent = content.value;
      content.value = currentContent + '\n\n' + imageText;
      
      // Âº∫Âà∂MilkdownÈáçÊñ∞Ê∏≤ÊüìÂÜÖÂÆπ
      if (milkdownEditor) {
        milkdownEditor.action((ctx) => {
          const processedContent = processContentForDisplay(content.value);
          ctx.set(defaultValueCtx, processedContent);
        });
      }
    } else if (textareaRef.value) {
      // Âú®ÊñáÊú¨Ê®°Âºè‰∏ãÊèíÂÖ•ÂõæÁâáÂºïÁî®
      const textarea = textareaRef.value;
      const { selectionStart } = textarea;
      const beforeCursor = content.value.substring(0, selectionStart);
      const afterCursor = content.value.substring(selectionStart);
      
      content.value = beforeCursor + imageText + afterCursor;
      
      nextTick(() => {
        textarea.setSelectionRange(selectionStart + imageText.length, selectionStart + imageText.length);
        textarea.focus();
      });
    }
    
    return true;
  } catch (error) {
    console.error('Failed to handle image paste:', error);
    return false;
  }
}

// Â§ÑÁêÜÂõæÁâáÊòæÁ§∫ - Â∞ÜObsidianÂºèÂõæÁâáÂºïÁî®ËΩ¨Êç¢‰∏∫ÂÆûÈôÖË∑ØÂæÑ
function processContentForDisplay(content: string): string {
  // Â§ÑÁêÜObsidianÂºèÂõæÁâáÂºïÁî® ![[filename.ext]]
  return content.replace(/!\[\[([^\]]+)\]\]/g, (match, fileName) => {
    // ‰ΩøÁî®Áõ∏ÂØπË∑ØÂæÑÊàñÁªùÂØπË∑ØÂæÑÔºåÊ†πÊçÆÈúÄË¶ÅË∞ÉÊï¥
    return `![${fileName}](attachments/${fileName})`;
  });
}

// ÂØºÂá∫ÂõæÁâáÁºìÂ≠òÊï∞ÊçÆÔºåÁî®‰∫é‰øùÂ≠òÊó∂ÂåÖÂê´ÂõæÁâá
function exportContentWithImages(content: string): string {
  // Â∞ÜÂõæÁâáÂºïÁî®ËΩ¨Êç¢‰∏∫base64Êï∞ÊçÆÔºåÁî®‰∫éÂØºÂá∫
  return processContentForDisplay(content);
}

// ObsidianÂºèÂõæÁâáÂ§ÑÁêÜ‰∏çÈúÄË¶ÅËΩ¨Êç¢ÔºåÁõ¥Êé•ËøîÂõûÂéüÂÜÖÂÆπ
function convertImageRefsFromMarkdown(markdown: string): string {
  // ÂØπ‰∫éObsidianÂºèÂºïÁî®Ôºå‰∏çÈúÄË¶ÅÁâπÊÆäÂ§ÑÁêÜÔºåÁõ¥Êé•ËøîÂõû
  return markdown;
}

// ÁõëÂê¨ÂÜÖÂÆπÂèòÂåñÔºåÂêåÊ≠•Âà∞MilkdownÁºñËæëÂô®
watch(content, async (newValue, oldValue) => {
  if (isWysiwygMode.value && milkdownEditor && newValue !== oldValue && !isUpdatingMilkdown) {
    try {
      isUpdatingMilkdown = true;
      const processedNewValue = processContentForDisplay(newValue || '');
      
      // ÈîÄÊØÅÁé∞ÊúâÁºñËæëÂô®Âπ∂ÈáçÊñ∞ÂàõÂª∫‰ª•Á°Æ‰øùÂÜÖÂÆπÊ≠£Á°ÆÂä†ËΩΩ
      milkdownEditor.destroy();
      milkdownEditor = null;
      
      await nextTick();
      await initMilkdownEditor();
    } catch (error) {
      console.error('Error updating Milkdown content:', error);
    } finally {
      isUpdatingMilkdown = false;
    }
  }
});

// ÊèíÂÖ•ÈìæÊé•
function insertLink() {
  const textarea = textareaRef.value!;
  const { selectionStart, selectionEnd } = textarea;
  const selectedText = content.value.substring(selectionStart, selectionEnd);
  
  const linkText = selectedText || 'link text';
  const url = prompt('ËØ∑ËæìÂÖ•ÈìæÊé•Âú∞ÂùÄ:', 'https://');
  
  if (url) {
    const linkMarkdown = `[${linkText}](${url})`;
    content.value = content.value.substring(0, selectionStart) + linkMarkdown + content.value.substring(selectionEnd);
    
    nextTick(() => {
      if (!selectedText) {
        textarea.setSelectionRange(selectionStart + 1, selectionStart + 1 + linkText.length);
      } else {
        textarea.setSelectionRange(selectionStart + linkMarkdown.length, selectionStart + linkMarkdown.length);
      }
      textarea.focus();
    });
  }
}

// ÊèíÂÖ•Êç¢Ë°å
function insertLineBreak() {
  const textarea = textareaRef.value!;
  const { selectionStart } = textarea;
  
  content.value = content.value.substring(0, selectionStart) + '  \n' + content.value.substring(selectionStart);
  
  nextTick(() => {
    textarea.setSelectionRange(selectionStart + 3, selectionStart + 3);
    textarea.focus();
  });
}

// Ê≥®ÊÑèÔºöÊñá‰ª∂Êìç‰Ωú„ÄÅËßÜÂõæÊ®°Âºè„ÄÅÂ∏ÉÂ±ÄÊ®°ÂºèÁ≠âÂäüËÉΩÁé∞Âú®ÈÉΩÁî±Áà∂ÁªÑ‰ª∂ NoteEditor Â§ÑÁêÜ

// Êü•ÊâæÊõøÊç¢ÂäüËÉΩ
function findNext() {
  if (!findText.value) return;
  
  const textarea = textareaRef.value;
  if (!textarea) return;
  
  let searchText = findText.value;
  let content = textarea.value;
  
  if (!caseSensitive.value) {
    searchText = searchText.toLowerCase();
    content = content.toLowerCase();
  }
  
  const startPos = textarea.selectionEnd;
  let index = content.indexOf(searchText, startPos);
  
  if (index === -1) {
    // ‰ªéÂ§¥ÂºÄÂßãÊêúÁ¥¢
    index = content.indexOf(searchText, 0);
  }
  
  if (index !== -1) {
    textarea.setSelectionRange(index, index + findText.value.length);
    textarea.focus();
  }
}

function replaceNext() {
  if (!findText.value) return;
  
  const textarea = textareaRef.value;
  if (!textarea) return;
  
  const selectedText = textarea.value.substring(textarea.selectionStart, textarea.selectionEnd);
  
  if (selectedText === findText.value || (!caseSensitive.value && selectedText.toLowerCase() === findText.value.toLowerCase())) {
    const beforeSelection = textarea.value.substring(0, textarea.selectionStart);
    const afterSelection = textarea.value.substring(textarea.selectionEnd);
    
    content.value = beforeSelection + replaceText.value + afterSelection;
    
    nextTick(() => {
      textarea.setSelectionRange(
        beforeSelection.length,
        beforeSelection.length + replaceText.value.length
      );
      findNext();
    });
  } else {
    findNext();
  }
}

function replaceAll() {
  if (!findText.value) return;
  
  let searchText = findText.value;
  let replaceStr = replaceText.value;
  
  if (caseSensitive.value) {
    content.value = content.value.split(searchText).join(replaceStr);
  } else {
    const regex = new RegExp(searchText.replace(/[.*+?^${}()|[\]\\]/g, '\\$&'), 'gi');
    content.value = content.value.replace(regex, replaceStr);
  }
}

// Êí§ÈîÄÈáçÂÅöÂéÜÂè≤
const undoStack = ref<string[]>([]);
const redoStack = ref<string[]>([]);
const maxHistorySize = 50;

// ‰øùÂ≠òÂéÜÂè≤Áä∂ÊÄÅ
function saveToHistory() {
  if (undoStack.value.length >= maxHistorySize) {
    undoStack.value.shift();
  }
  undoStack.value.push(content.value);
  redoStack.value = []; // Ê∏ÖÁ©∫ÈáçÂÅöÊ†à
}

// Êí§ÈîÄÊìç‰Ωú
function undo() {
  if (undoStack.value.length > 0) {
    redoStack.value.push(content.value);
    const previousState = undoStack.value.pop();
    if (previousState !== undefined) {
      content.value = previousState;
    }
  }
}

// ÈáçÂÅöÊìç‰Ωú
function redo() {
  if (redoStack.value.length > 0) {
    undoStack.value.push(content.value);
    const nextState = redoStack.value.pop();
    if (nextState !== undefined) {
      content.value = nextState;
    }
  }
}

// ÈîÆÁõòÂø´Êç∑ÈîÆ
function handleKeyDown(event: KeyboardEvent) {
  if (event.ctrlKey || event.metaKey) {
    switch (event.key) {
      case 's':
        event.preventDefault();
        emit('save');
        break;
      case 'z':
        event.preventDefault();
        if (event.shiftKey) {
          redo();
        } else {
          undo();
        }
        break;
      case 'y':
        event.preventDefault();
        redo();
        break;
      case 'f':
        event.preventDefault();
        showFindReplace.value = true;
        break;
      case 'b':
        event.preventDefault();
        insertFormat('**', '**');
        break;
      case 'i':
        event.preventDefault();
        insertFormat('*', '*');
        break;
      case 'k':
        event.preventDefault();
        insertLink();
        break;
      case 'Enter':
        event.preventDefault();
        insertLineBreak();
        break;
      case '/':
        event.preventDefault();
        showFindReplace.value = true;
        break;
    }
  }
  
  if (event.key === 'Escape') {
    showFindReplace.value = false;
  }
  
  // Alt + Êï∞Â≠óÈîÆÂø´ÈÄüÊèíÂÖ•Ê†áÈ¢ò
  if (event.altKey && event.key >= '1' && event.key <= '6') {
    event.preventDefault();
    insertHeading(parseInt(event.key));
  }
}

onMounted(() => {
  document.addEventListener('keydown', handleKeyDown);
  
  // ÈªòËÆ§ÂêØÂä®WYSIWYGÊ®°Âºè
  if (isWysiwygMode.value) {
    nextTick(() => {
      initMilkdownEditor();
    });
  }
});

onUnmounted(() => {
  document.removeEventListener('keydown', handleKeyDown);
  
  // Ê∏ÖÁêÜMilkdownÁºñËæëÂô®Âíå‰∫ã‰ª∂ÁõëÂê¨Âô®
  if (milkdownRef.value) {
    milkdownRef.value.removeEventListener('paste', handleMilkdownPaste);
  }
  
  if (milkdownEditor) {
    milkdownEditor.destroy();
    milkdownEditor = null;
  }
  
  // Ê∏ÖÁêÜÂ∑•‰ΩúÔºàObsidianÂºèÂ≠òÂÇ®‰∏çÈúÄË¶ÅÊ∏ÖÁêÜÁºìÂ≠òÔºâ
});
</script>

<style scoped>
.markdown-editor {
  @apply bg-white dark:bg-dark-900;
}

.editor-toolbar {
  @apply bg-gray-50 dark:bg-dark-800;
}

.toolbar-btn {
  @apply p-2 rounded hover:bg-gray-200 dark:hover:bg-dark-700;
  @apply text-gray-600 dark:text-gray-400;
  @apply transition-colors duration-200;
}

.editor-textarea {
  @apply w-full h-full resize-none border-none outline-none;
  @apply bg-transparent text-gray-900 dark:text-gray-100;
  @apply placeholder-gray-400 dark:placeholder-gray-500;
  @apply p-4 font-mono text-sm leading-6;
}

.line-numbers {
  @apply absolute left-0 top-0 w-12 h-full;
  @apply bg-gray-50 dark:bg-dark-800 border-r border-gray-200 dark:border-dark-600;
  @apply pt-4 text-right pr-2;
  @apply text-xs text-gray-400 dark:text-gray-500;
  @apply font-mono leading-6;
  @apply select-none;
}

.line-number {
  @apply h-6;
}

.prose {
  @apply text-gray-900;
}

.dark .prose {
  @apply text-gray-100;
}

.prose h1, .prose h2, .prose h3, .prose h4, .prose h5, .prose h6 {
  @apply text-gray-900 dark:text-gray-100;
}

.prose p {
  @apply text-gray-700 dark:text-gray-300;
}

.prose code {
  @apply bg-gray-100 dark:bg-dark-700 text-gray-800 dark:text-gray-200 px-1 py-0.5 rounded text-sm;
}

.prose pre {
  @apply bg-gray-100 dark:bg-dark-700 text-gray-800 dark:text-gray-200 p-4 rounded-lg overflow-x-auto;
}

.prose pre code {
  @apply bg-transparent p-0;
}

.prose blockquote {
  @apply border-l-4 border-primary-500 pl-4 italic text-gray-600 dark:text-gray-400;
}

.prose ul, .prose ol {
  @apply text-gray-700 dark:text-gray-300;
}

.prose a {
  @apply text-primary-600 dark:text-primary-400 hover:text-primary-700 dark:hover:text-primary-300;
}

.prose table {
  @apply border-collapse border border-gray-300 dark:border-dark-600;
}

.prose th, .prose td {
  @apply border border-gray-300 dark:border-dark-600 px-4 py-2;
}

.prose th {
  @apply bg-gray-100 dark:bg-dark-700 font-semibold;
}

/* Êü•ÊâæÊõøÊç¢ÂØπËØùÊ°ÜÊ†∑Âºè */
.find-replace-dialog {
  min-width: 320px;
}

/* ÂìçÂ∫îÂºèË∞ÉÊï¥ */
@media (max-width: 768px) {
  .find-replace-dialog {
    @apply w-72 right-2;
  }
}

/* Typography Êèí‰ª∂Ëá™ÂÆö‰πâÊ†∑Âºè */
.prose {
  font-size: 16px;
  line-height: 1.75;
}

/* Ëá™ÂÆö‰πâ‰∏Ä‰∫õË∞ÉÊï¥ */
.prose h1 {
  border-bottom: 3px solid #3b82f6;
  padding-bottom: 0.5rem;
}

.dark .prose h1 {
  border-bottom-color: #60a5fa;
}

.prose h2 {
  border-bottom: 1px solid #e5e7eb;
  padding-bottom: 0.25rem;
}

.dark .prose h2 {
  border-bottom-color: #4b5563;
}

.prose blockquote {
  background-color: rgba(59, 130, 246, 0.05);
  border-radius: 0.375rem;
  padding: 1rem;
}

.dark .prose blockquote {
  background-color: rgba(59, 130, 246, 0.1);
}

.prose pre {
  box-shadow: 0 1px 3px 0 rgba(0, 0, 0, 0.1);
}

.dark .prose pre {
  box-shadow: 0 1px 3px 0 rgba(0, 0, 0, 0.3);
}

.prose table {
  box-shadow: 0 1px 3px 0 rgba(0, 0, 0, 0.1);
  border-radius: 0.5rem;
  overflow: hidden;
}

.dark .prose table {
  box-shadow: 0 1px 3px 0 rgba(0, 0, 0, 0.3);
}

.prose img {
  box-shadow: 0 4px 6px -1px rgba(0, 0, 0, 0.1);
  border-radius: 0.5rem;
  transition: transform 0.2s ease;
}

.prose img:hover {
  transform: scale(1.02);
}

/* WYSIWYG ÁºñËæëÂô®Ê†∑Âºè */
.wysiwyg-editor {
  min-height: 200px;
  cursor: text;
  background-color: transparent;
  border: none;
  outline: none;
}

.wysiwyg-editor:empty:before {
  content: attr(data-placeholder);
  color: #9ca3af;
  font-style: italic;
  pointer-events: none;
}

.dark .wysiwyg-editor:empty:before {
  color: #6b7280;
}

/* WYSIWYG ÁºñËæëÂô®‰∏≠ÁöÑÂÖÉÁ¥†Ê†∑ÂºèË∞ÉÊï¥ */
.wysiwyg-editor * {
  outline: none;
}

.wysiwyg-editor h1,
.wysiwyg-editor h2,
.wysiwyg-editor h3,
.wysiwyg-editor h4,
.wysiwyg-editor h5,
.wysiwyg-editor h6 {
  cursor: text;
}

.wysiwyg-editor p {
  cursor: text;
  min-height: 1.5em;
}

.wysiwyg-editor li {
  cursor: text;
}

.wysiwyg-editor blockquote {
  cursor: text;
}

.wysiwyg-editor code {
  cursor: text;
}

.wysiwyg-editor pre {
  cursor: text;
}

/* ÈÄâ‰∏≠ÊñáÊú¨ÁöÑÊ†∑Âºè */
.wysiwyg-editor ::selection {
  background-color: rgba(59, 130, 246, 0.3);
}

.dark .wysiwyg-editor ::selection {
  background-color: rgba(96, 165, 250, 0.3);
}

/* È¢ÑËßàÂå∫ÂüüÊªöÂä®Êù°Ê†∑Âºè */
.prose::-webkit-scrollbar {
  width: 8px;
}

.prose::-webkit-scrollbar-track {
  @apply bg-gray-100 dark:bg-gray-700;
}

.prose::-webkit-scrollbar-thumb {
  @apply bg-gray-300 dark:bg-gray-500 rounded-full;
}

.prose::-webkit-scrollbar-thumb:hover {
  @apply bg-gray-400 dark:bg-gray-400;
}

/* Milkdown ÁºñËæëÂô®Ê†∑Âºè */
.milkdown-editor {
  background: transparent;
  font-family: inherit;
  height: 100%;
}

/* Ëá™ÂÆö‰πâ Milkdown ÁºñËæëÂô®Ê†∑Âºè‰ª•ÈÄÇÈÖçÂΩìÂâç‰∏ªÈ¢ò */
:deep(.milkdown) {
  @apply bg-transparent;
  @apply text-gray-900 dark:text-gray-100;
  height: 100%;
  outline: none;
  border: none;
}

:deep(.milkdown .editor) {
  @apply bg-transparent;
  height: 100%;
  padding: 0;
  outline: none;
}

:deep(.milkdown .ProseMirror) {
  @apply bg-transparent;
  @apply text-gray-900 dark:text-gray-100;
  height: 100%;
  padding: 0;
  outline: none;
  border: none;
  min-height: 100%;
}

:deep(.milkdown h1) {
  @apply text-gray-900 dark:text-gray-100;
  border-bottom: 3px solid #3b82f6;
  padding-bottom: 0.5rem;
}

:deep(.milkdown h2) {
  @apply text-gray-900 dark:text-gray-100;
  border-bottom: 1px solid #e5e7eb;
  padding-bottom: 0.25rem;
}

:deep(.dark .milkdown h1) {
  border-bottom-color: #60a5fa;
}

:deep(.dark .milkdown h2) {
  border-bottom-color: #4b5563;
}

:deep(.milkdown h3),
:deep(.milkdown h4),
:deep(.milkdown h5),
:deep(.milkdown h6) {
  @apply text-gray-900 dark:text-gray-100;
}

:deep(.milkdown p) {
  @apply text-gray-700 dark:text-gray-300;
}

:deep(.milkdown code) {
  @apply bg-gray-100 dark:bg-gray-700 text-gray-800 dark:text-gray-200 px-1 py-0.5 rounded text-sm;
}

:deep(.milkdown pre) {
  @apply bg-gray-100 dark:bg-gray-700 text-gray-800 dark:text-gray-200 p-4 rounded-lg;
  box-shadow: 0 1px 3px 0 rgba(0, 0, 0, 0.1);
}

:deep(.dark .milkdown pre) {
  box-shadow: 0 1px 3px 0 rgba(0, 0, 0, 0.3);
}

:deep(.milkdown blockquote) {
  @apply border-l-4 border-primary-500 pl-4 italic text-gray-600 dark:text-gray-400;
  background-color: rgba(59, 130, 246, 0.05);
  border-radius: 0.375rem;
  padding: 1rem;
}

:deep(.dark .milkdown blockquote) {
  background-color: rgba(59, 130, 246, 0.1);
}

:deep(.milkdown ul),
:deep(.milkdown ol) {
  @apply text-gray-700 dark:text-gray-300;
}

:deep(.milkdown a) {
  @apply text-primary-600 dark:text-primary-400 hover:text-primary-700 dark:hover:text-primary-300;
}

:deep(.milkdown table) {
  @apply border-collapse border border-gray-300 dark:border-gray-600;
  box-shadow: 0 1px 3px 0 rgba(0, 0, 0, 0.1);
  border-radius: 0.5rem;
  overflow: hidden;
}

:deep(.dark .milkdown table) {
  box-shadow: 0 1px 3px 0 rgba(0, 0, 0, 0.3);
}

:deep(.milkdown th),
:deep(.milkdown td) {
  @apply border border-gray-300 dark:border-gray-600 px-4 py-2;
}

:deep(.milkdown th) {
  @apply bg-gray-100 dark:bg-gray-700 font-semibold;
}

:deep(.milkdown img) {
  box-shadow: 0 4px 6px -1px rgba(0, 0, 0, 0.1);
  border-radius: 0.5rem;
  transition: transform 0.2s ease;
}

:deep(.milkdown img:hover) {
  transform: scale(1.02);
}
</style>
